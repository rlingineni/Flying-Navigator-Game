<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Going Back Home</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://unpkg.com/mustache@latest"></script>
    <script src="./js/three.js"></script>
    <script src="./js/keydrown.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link href="main.css" rel="stylesheet" />
    <link href="css/semantic.min.css" rel="stylesheet" />
  </head>
  <style>
    #overlay {
      position: absolute;
    }

    #hud {
      height: 8.2em;
      width: 100%;
      background-color: rgba(122, 147, 151, 0.6);
      border-bottom: 1px solid burlywood;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      padding: 2px 10px;
      gap: 15px;
    }

    #small-terminal {
      background: #000000;
      color: #05ff00;
      font-family: "IBM Plex Mono", monospace;
      font-style: normal;
      font-weight: 200;
      font-size: 1em;
      line-height: 0.5em;
      border-radius: 10px;
      padding: 8px 12px;
      max-width: 600px;
    }

    #small-terminal p {
      line-height: 1em;
    }

    #gauge {
      background-color: gray;
    }

    #loader {
      height: 30px;
      border-radius: 4px;
    }

    .circle-button {
      border-radius: 50%;
      width: 4.5em;
      height: 4.5em;
      background: #d9d9d9;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .circle-button:hover {
      background: gray;
    }
  </style>
  <body>
    <div id="map"></div>
    <div id="overlay">
      <div class="ui modal">
        <i class="close icon"></i>
        <div class="header">Modal Title</div>
        <div class="image content">
          <div class="image">An image can appear on left or an icon</div>
          <div class="description">A description can appear on the right</div>
        </div>
        <div class="actions">
          <div class="ui button">Cancel</div>
          <div class="ui button">OK</div>
        </div>
      </div>
      <div id="hud">
        <div style="display: flex; align-items: center">
          <svg
            style="margin-right: 16px; transform: scale(0.8)"
            width="75"
            height="73"
            viewBox="0 0 75 73"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <ellipse cx="37.5" cy="36.5" rx="37.5" ry="36.5" fill="#212121" />
            <g class="light-rotate">
              <path
                d="M35.8654 7.08671C36.786 6.22798 38.214 6.22798 39.1346 7.08671L56.2499 23.0526C57.8405 24.5364 56.7905 27.2012 54.6153 27.2012H20.3847C18.2095 27.2012 17.1595 24.5364 18.7501 23.0526L35.8654 7.08671Z"
                fill="#9F5547"
              />
              <rect
                x="16.5898"
                y="29.2"
                width="42.1659"
                height="32.3286"
                rx="4.79263"
                fill="#D8B98D"
              />
            </g>
          </svg>
          <div id="small-terminal">
            <p>Destination:</p>
            <p>Dallas-Fort Worth (DFW)</p>
          </div>
          <div style="margin-left: 12px">
            <div>
              <div
                style="color: #515050; margin-right: 10px; font-weight: bold"
              >
                Fuel
              </div>
              <div
                id="loading-bar"
                class="ui success progress"
                style="margin: 0px; min-width: 0px"
              >
                <div id="gauge" class="bar" style="min-width: 0px">
                  <div class="progress"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 12px">
          <div class="circle-button" id="pause-button">
            <svg
              id="pause-icon"
              width="16"
              height="25"
              viewBox="0 0 16 25"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect width="6" height="25" rx="2" fill="#494949" />
              <rect x="10" width="6" height="25" rx="2" fill="#494949" />
            </svg>
            <svg
              id="play-icon"
              style="display: none"
              width="20"
              height="23"
              viewBox="0 0 20 23"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M17.9556 8.79561C19.8965 9.96101 19.8965 12.7742 17.9556 13.9396L4.7889 21.8454C2.78934 23.046 0.244572 21.6058 0.244572 19.2734L0.244572 3.46173C0.244572 1.12941 2.78934 -0.310858 4.7889 0.889764L17.9556 8.79561Z"
                fill="#494949"
              />
            </svg>
          </div>
          <div class="circle-button">
            <svg
              width="43"
              height="41"
              viewBox="0 0 43 41"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M22.6153 39.1474C51.2889 26.3227 29.3223 -3.79447 14.4783 12.3591"
                stroke="#494949"
                stroke-width="4"
              />
              <path
                d="M9.10335 6.85674C9.86637 4.7253 12.6251 4.17474 14.1478 5.85003L19.6691 11.9245C21.2378 13.6505 20.3234 16.4279 18.0362 16.8844L9.74828 18.5383C7.46106 18.9948 5.55061 16.7811 6.33668 14.5853L9.10335 6.85674Z"
                fill="#494949"
              />
            </svg>
          </div>
          <div class="circle-button">
            <svg
              width="36"
              height="34"
              viewBox="0 0 36 34"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect y="5" width="16" height="7" rx="2" fill="#494949" />
              <rect y="16" width="16" height="7" rx="2" fill="#494949" />
              <rect y="27" width="16" height="7" rx="2" fill="#494949" />
              <path
                d="M22.428 4.28346C23.5934 2.34256 26.4066 2.34256 27.572 4.28345L31.7977 11.3211C32.9983 13.3206 31.558 15.8654 29.2257 15.8654L20.7743 15.8654C18.442 15.8654 17.0017 13.3206 18.2023 11.3211L22.428 4.28346Z"
                fill="#494949"
              />
              <rect x="22" y="12" width="6" height="22" rx="2" fill="#494949" />
            </svg>
          </div>
        </div>
      </div>
      <div id="dimmer" class="ui active dimmer">
        <div id="loader" class="ui text loader">
          Get Home Safely! Starting your flight...
        </div>
      </div>
      <div id="airplane"></div>
    </div>

    <script src="js/hammer.min.js" type="module"></script>

    <script type="module">
      import { initAirplane, destroyAirplane } from "./airplane.js";
      import { FLIGHT_PATHS } from "./locations.js";

      let dimmerEl = document.getElementById("dimmer");
      let progressEl = document.getElementById("loading-bar");
      let gaugeEl = document.getElementById("gauge");

      let guageBounds = gaugeEl.getBoundingClientRect();

      //select a random Flight Path from the random list of integers

      let activeFlightPath = FLIGHT_PATHS[0];
      //LIGHT: mapbox://styles/johnny5coder/ck9kkxb1z1vmr1iojge6490xw
      //DARK: mapbox://styles/johnny5coder/ck9kkvcao1vh71io7u2hji0kr
      mapboxgl.accessToken =
        "pk.eyJ1Ijoiam9obm55NWNvZGVyIiwiYSI6ImNrOWs1emJsajFycHgzZXF0ZmZrZ2pubnUifQ.1rLHck77FdpZGEUqR8Qn5g";
      let map = new mapboxgl.Map({
        container: "map", // container id
        style: "mapbox://styles/johnny5coder/ck9kkxb1z1vmr1iojge6490xw", //hosted style id
        center: activeFlightPath.start, // starting position
        zoom: 10, // starting zoom
        interactive: false,
        pitch: 60, // pitch in degrees
        bearing: 0, // bearing in degrees
      });

      function easing(t) {
        return t * (2 - t);
      }

      let shouldTurn = false;
      let degreesToTurn = 0;
      let planeSpeed = 0.01;
      let isGamePaused = false;
      let isGameOver = false;
      let fuelAmount = 1;
      let mapZoom = 10;

      let destination = new mapboxgl.Marker()
        .setLngLat(activeFlightPath.center)
        .setPopup(new mapboxgl.Popup().setHTML("<h3>home</h3>"))
        .addTo(map);
      destination.togglePopup();
      let { sw, ne } = activeFlightPath.bounds;
      let destinationBounds = new mapboxgl.LngLatBounds(sw, ne);

      const pauseButton = document.getElementById("pause-button");
      pauseButton.addEventListener("click", onPlanePause, false);

      function onPlanePause() {
        const playIcon = document.getElementById("play-icon");
        const pauseIcon = document.getElementById("pause-icon");
        playIcon.style.display = "block";

        isGamePaused = !isGamePaused;
        if (isGamePaused) {
          playIcon.style.display = "block";
          pauseIcon.style.display = "none";
        } else {
          playIcon.style.display = "none";
          pauseIcon.style.display = "block";
        }
      }

      map.on("load", function () {
        map.getCanvas().focus();

        //Do any Map Animations Here. Too slow for the 3js animate loop.
        let gameloop = setInterval(() => {
          if (isGamePaused) {
            return;
          }

          if (isGameOver) {
            handleGameOver();
            return;
          }

          let { lat, lng } = map.getCenter();

          let easeOptions = {
            easing: easing,
          };

          if (shouldTurn) {
            easeOptions.bearing = map.getBearing() + degreesToTurn;
          }

          //based on the heading - change the lat long
          let headingSpeed = determineHeadingSpeed(
            map.getBearing() + degreesToTurn,
            planeSpeed
          );

          easeOptions.center = {
            lat: lat + headingSpeed.lat,
            lng: lng + headingSpeed.long,
          };

          if (destinationBounds.contains(map.getCenter())) {
            isGameOver = true;
          }

          map.easeTo(easeOptions);
          //decrease the 2 minute timer, divide by 600 because it runs every 200ms
          fuelAmount -= 1 / 600;

          gaugeEl.transformOrigin = "left center;";
          gaugeEl.style.width = `${300 * fuelAmount}px`;

          if (fuelAmount < 0.5 && fuelAmount > 0.2) {
            progressEl.classList.replace("success", "warning");
          }

          if (fuelAmount < 0.2) {
            progressEl.classList.replace("warning", "error");
          }

          if (fuelAmount <= 0) {
            isGameOver = true;
          }
        }, 200);

        function handleGameOver() {
          map.easeTo({ pitch: 0, zoom: 4, easing });
          var nav = new mapboxgl.NavigationControl();
          let marker = new mapboxgl.Marker()
            .setLngLat(map.getCenter())
            .setPopup(new mapboxgl.Popup().setHTML("<h3>you</h3>"))
            .addTo(map);
          map.addControl(nav, "bottom-left");
          marker.togglePopup();
          clearInterval(gameloop);
          destroyAirplane();

          if (fuelAmount <= 0) {
            alert("You ran out of fuel!!");
          } else {
            alert("Congrats you made it Home!!!");
          }
        }

        //Evt handler for plane turning
        function onPlaneTurn(isLevel, dToTurn) {
          if (!isLevel) {
            shouldTurn = true;
            degreesToTurn = dToTurn;
            return;
          }
          degreesToTurn = 0;
          shouldTurn = false;
        }

        //adjusts the plane speed
        function onSpeedChange(direction) {
          switch (direction) {
            case "up":
              planeSpeed = Math.max(0.01, planeSpeed + 0.01);
              break;
            case "down":
              planeSpeed = Math.max(0.01, planeSpeed - 0.01);
              break;
          }
        }

        //Calculates the right lat and long rate changes based on angle of flight
        function determineHeadingSpeed(bearing, rateOfChange) {
          let long =
            Math.sin(toRadians(bearing)) * (rateOfChange * Math.sqrt(2));
          let lat =
            Math.cos(toRadians(bearing)) * (rateOfChange * Math.sqrt(2));
          console.log(
            `Heading ${bearing} - speed in direction X: ${lat}, speed in direction Y:${long}`
          );
          return { lat, long };
        }

        function toRadians(angle) {
          return angle * (Math.PI / 180);
        }

        initAirplane({ onPlaneTurn, onSpeedChange, onPlanePause }, false);
        dimmerEl.classList.remove("active");
      });
    </script>
  </body>
</html>
